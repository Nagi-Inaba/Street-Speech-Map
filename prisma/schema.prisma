// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// SQLiteではenumが使えないため、Stringで管理
// EventStatus: "PLANNED" | "LIVE" | "ENDED"
// RequestType: "CREATE_EVENT" | "UPDATE_EVENT" | "REPORT_START" | "REPORT_END" | "REPORT_MOVE" | "REPORT_TIME_CHANGE" | "CREATE_RIVAL_EVENT" | "UPDATE_RIVAL_EVENT"
// RequestStatus: "PENDING" | "APPROVED" | "REJECTED" | "DUPLICATE"
// CandidateType: "SINGLE" | "PROPORTIONAL"

model Candidate {
  id        String   @id @default(cuid())
  slug      String   @unique
  name      String
  imageUrl  String?
  type      String   // "SINGLE" | "PROPORTIONAL"
  prefecture String? // 小選挙区の場合の都道府県
  region    String?  // 例: 選挙区や運用上の地域
  showEvents Boolean  @default(false) // 演説予定の表示（候補者個別設定、デフォルトは非表示）
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events    SpeechEvent[]
  requests  PublicRequest[]
  additionalEvents EventCandidate[] // 合同演説として参加しているイベント
}

model SpeechEvent {
  id          String   @id @default(cuid())
  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  status      String   @default("PLANNED") // "PLANNED" | "LIVE" | "ENDED"

  // 時間未定（方式C）対応：null可＋フラグ
  startAt     DateTime?
  endAt       DateTime?
  timeUnknown Boolean     @default(false)

  // 公式地点
  lat         Float
  lng         Float
  locationText String
  notes       String?    // 備考（応援演説など）

  // 予約入力時刻（公開表示するため、承認時刻ではない）
  submittedAt DateTime    @default(now())

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  histories   EventHistory[]
  moveHints   MoveHint[]
  reports     PublicReport[]
  additionalCandidates EventCandidate[] // 合同演説者

  @@index([candidateId])
  @@index([status])
  @@index([startAt])
}

// 合同演説者の中間テーブル
model EventCandidate {
  id          String   @id @default(cuid())
  eventId     String
  event       SpeechEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())

  @@unique([eventId, candidateId])
  @@index([eventId])
  @@index([candidateId])
}

model RivalEvent {
  id          String   @id @default(cuid())
  name        String
  startAt     DateTime?
  endAt       DateTime?
  timeUnknown Boolean  @default(false)
  lat         Float
  lng         Float
  locationText String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([startAt])
}

model EventHistory {
  id          String   @id @default(cuid())
  eventId     String
  event       SpeechEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // 変更前→変更後
  fromLat     Float?
  fromLng     Float?
  fromText    String?
  fromStartAt DateTime?
  fromEndAt   DateTime?

  toLat       Float?
  toLng       Float?
  toText      String?
  toStartAt   DateTime?
  toEndAt     DateTime?

  reason      String?
  changedByUserId String?
  changedAt   DateTime @default(now())

  @@index([eventId])
}

model PublicRequest {
  id          String   @id @default(cuid())
  type        String   // "CREATE_EVENT" | "UPDATE_EVENT" | "REPORT_START" | "REPORT_END" | "REPORT_MOVE" | "CREATE_RIVAL_EVENT" | "UPDATE_RIVAL_EVENT"
  status      String   @default("PENDING") // "PENDING" | "APPROVED" | "REJECTED" | "DUPLICATE"

  candidateId String?
  candidate   Candidate? @relation(fields: [candidateId], references: [id], onDelete: SetNull)
  eventId     String?
  rivalEventId String?

  // 提案内容（create/update向け）- SQLiteではJSONを文字列として保存
  payload     String

  // 重複判定キー（同一候補・同日・同時間帯・位置グリッド）
  dedupeKey   String?
  createdAt   DateTime @default(now())
  reviewedAt  DateTime?
  reviewedByUserId String?

  @@index([status])
  @@index([candidateId])
  @@index([dedupeKey])
  @@index([createdAt])
}

model PublicReport {
  id        String   @id @default(cuid())
  eventId   String
  event     SpeechEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  kind      String   // "start" | "end" | "move" | "check"
  lat       Float?
  lng       Float?

  // 個人特定しない形でのユニーク判定用（salted hash）
  reporterHash String
  createdAt DateTime @default(now())

  @@index([eventId, kind, createdAt])
  @@unique([eventId, kind, reporterHash])
}

model MoveHint {
  id        String @id @default(cuid())
  eventId   String
  event     SpeechEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // 推定地点（クラスター代表）
  lat       Float
  lng       Float
  count     Int
  lastReportAt DateTime
  active    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventId, active])
}

model Facility {
  id        String @id @default(cuid())
  category  String // "school" "hospital" etc
  name      String?
  lat       Float
  lng       Float
  source    String // dataset/version
  createdAt DateTime @default(now())

  @@index([category])
  @@index([lat, lng])
}

model User {
  id        String @id @default(cuid())
  email     String @unique
  userId    String? @unique // 数字ID（ログイン用）
  passwordHash String? // パスワードハッシュ
  name      String?
  role      String // "SiteAdmin" "SiteStaff" "PartyAdmin" "RegionEditor"
  region    String? // 地域担当の場合
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts  Account[]
  sessions  Session[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model SiteSettings {
  id        String   @id @default("site-settings")
  // 立候補区分・選挙区の表示制御（公選法対応）
  showCandidateInfo Boolean  @default(true)
  // 候補者ラベル（デフォルト: "候補者"）
  candidateLabel    String   @default("候補者")
  // 演説予定の表示制御
  showEvents        Boolean  @default(true)
  updatedAt DateTime @updatedAt

  @@unique([id])
}